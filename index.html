<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Magic Tiles Lite — Hard Mode + Music (v5)</title>

  <!-- ==================== STYLES ==================== -->
  <style>
    :root{
      --tile-top:#4facfe;
      --tile-bottom:#00f2fe;
      --bg-1:#0f0c29;
      --bg-2:#302b63;
      --bg-3:#24243e;
    }

    html,body{
      margin:0;padding:0;height:100%;overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,var(--bg-1),var(--bg-2),var(--bg-3));
      background-size:400% 400%;animation:bgShift 20s ease infinite;
    }
    @keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    /* CELEBRATION THEME: rainbow hue rotation */
    body.celebrate{animation:bgHue 8s linear infinite;}
    @keyframes bgHue{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}

    /* Score badge */
    #score{
      position:absolute;top:16px;left:50%;transform:translateX(-50%);
      padding:6px 24px;font-size:26px;color:#fff;letter-spacing:.5px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);
      border-radius:999px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
      box-shadow:0 4px 12px rgba(0,0,0,.35);user-select:none;z-index:20;
    }

    /* Progress bar */
    #progressContainer{
      position:absolute;top:64px;left:50%;transform:translateX(-50%);
      width:320px;height:12px;border-radius:6px;overflow:hidden;
      background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
      backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
      box-shadow:0 2px 6px rgba(0,0,0,.3);z-index:15; /* ensure on top of play‑area */
    }
    #progressBar{
      height:100%;width:0%;position:relative;z-index:1;
      background:linear-gradient(90deg,#12c2e9 0%,#c471ed 50%,#f64f59 100%);
      transition:width .15s ease-out;
    }
    /* Star at end */
    #star{
      position:absolute;right:-18px;top:-10px;z-index:5; /* above bar */
      font-size:28px;pointer-events:none;opacity:0.85;
      transition:transform .6s ease,filter .6s ease;
    }
    #star.shine{filter:drop-shadow(0 0 6px #fff) drop-shadow(0 0 12px #ff0);transform:scale(1.3) rotate(15deg);}

    /* Canvas */
    #gameCanvas{
      width:400px;height:600px;border-radius:20px;background:#111;
      box-shadow:0 20px 40px rgba(0,0,0,.6),inset 0 0 40px rgba(0,0,0,.8);
      touch-action:none;z-index:1;
    }

    /* Lane separators */
    .lane-sep{
      position:absolute;width:2px;height:600px;pointer-events:none;
      background:linear-gradient(to bottom,transparent 0%,rgba(255,255,255,.07) 50%,transparent 100%);
      top:calc(50% - 300px);z-index:2;
    }
  </style>
</head>
<body>
  <!-- AUDIO (royalty‑free track, 120 BPM) -->
  <audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/10/18/audio_eda73d5557.mp3?filename=pop-hip-hop-bounce-124441.mp3" preload="auto"></audio>

  <!-- HUD -->
  <div id="score">Score 0</div>
  <div id="progressContainer">
    <div id="progressBar"></div>
    <div id="star">⭐</div>
  </div>

  <!-- Play area -->
  <canvas id="gameCanvas" width="400" height="600"></canvas>
  <div class="lane-sep" style="left:calc(50% - 100px);"></div>
  <div class="lane-sep" style="left:calc(50%);"></div>
  <div class="lane-sep" style="left:calc(50% + 100px);"></div>

  <script>
    /* --------------------------------------------------------------------------
       MAGIC TILES LITE — HARD MODE + MUSIC (v5)
    --------------------------------------------------------------------------*/

    // ---------- CONSTANTS ----------
    const canvas   = document.getElementById('gameCanvas');
    const ctx      = canvas.getContext('2d');
    const scoreEl  = document.getElementById('score');
    const progBar  = document.getElementById('progressBar');
    const starEl   = document.getElementById('star');
    const audio    = document.getElementById('bgm');

    const LANES          = 4;
    const LANE_WIDTH     = canvas.width / LANES;
    const TILE_HEIGHT    = 110;
    const BPM            = 120;
    const SPAWN_INTERVAL = 60000 / BPM; // ms per beat
    const BASE_SPEED     = 4.5;
    const SPEED_STEP     = 0.08;
    const MAX_PROGRESS   = 100;

    // ---------- STATE ----------
    let tiles   = [];
    let speed   = BASE_SPEED;
    let score   = 0;
    let running = true;
    let barFull = false;
    let audioStarted = false;

    // ---------- HELPERS ----------
    function spawnTile(){ tiles.push({lane:Math.floor(Math.random()*LANES),y:-TILE_HEIGHT}); }

    function updateScore(v){
      scoreEl.textContent=`Score ${v}`;
      const pct=Math.min(v,MAX_PROGRESS)/MAX_PROGRESS*100;
      progBar.style.width=`${pct}%`;
      if(!barFull && v>=MAX_PROGRESS) onBarFull();
    }

    function onBarFull(){
      barFull = true;
      document.body.classList.add('celebrate');
      starEl.classList.add('shine');
      document.documentElement.style.setProperty('--tile-top','#ff9a9e');
      document.documentElement.style.setProperty('--tile-bottom','#fad0c4');
    }

    function resetGame(){
      tiles=[];speed=BASE_SPEED;score=0;running=true;barFull=false;
      document.body.classList.remove('celebrate');
      starEl.classList.remove('shine');
      document.documentElement.style.setProperty('--tile-top','#4facfe');
      document.documentElement.style.setProperty('--tile-bottom','#00f2fe');
      updateScore(0);
      requestAnimationFrame(loop);
    }

    // ---------- DRAW ----------
    function drawTile(lane,y){
      const x=lane*LANE_WIDTH+4;
      const g=ctx.createLinearGradient(0,y,0,y+TILE_HEIGHT);
      g.addColorStop(0,getComputedStyle(document.documentElement).getPropertyValue('--tile-top'));
      g.addColorStop(1,getComputedStyle(document.documentElement).getPropertyValue('--tile-bottom'));
      ctx.fillStyle=g;ctx.shadowColor='#fff';ctx.shadowBlur= barFull ? 15 : 10;
      ctx.fillRect(x,y,LANE_WIDTH-8,TILE_HEIGHT);ctx.shadowBlur=0;
    }

    function loop(){
      tiles.forEach(t=>t.y+=speed);
      if(tiles.some(t=>t.y+TILE_HEIGHT>=canvas.height)) running=false;
      tiles=tiles.filter(t=>t.y<canvas.height);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      tiles.forEach(t=>drawTile(t.lane,t.y));
      running?requestAnimationFrame(loop):drawGameOver();
    }

    function drawGameOver(){
      ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#fff';ctx.textAlign='center';ctx.font='36px sans-serif';
      ctx.fillText('Game Over',canvas.width/2,canvas.height/2-20);
      ctx.font='18px sans-serif';ctx.fillText('Tap to restart',canvas.width/2,canvas.height/2+22);
    }

    // ---------- INPUT ----------
    const KEY_TO_LANE={d:0,f:1,j:2,k:3};
    window.addEventListener('keydown',e=>{const l=KEY_TO_LANE[e.key.toLowerCase()];if(l!==undefined){startAudio();hit(l);}});

    canvas.addEventListener('pointerdown',handlePointer);
    function handlePointer(e){
      startAudio();
      const rect=canvas.getBoundingClientRect();
      const lane=Math.floor((e.clientX-rect.left)/LANE_WIDTH);
      const y=(e.clientY-rect.top);
      hit(lane,y);
    }
    canvas
